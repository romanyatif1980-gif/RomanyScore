<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romany Score - Prototype</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background: linear-gradient(120deg,#f7fbff,#fff8f0); color:#222; margin:0; padding:20px; direction:rtl}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .userbox{font-weight:600}
    .topbtns button{margin-left:8px}
    main{max-width:1000px;margin:0 auto;background:white;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(20,30,60,0.08)}
    .page{display:none}
    .page.active{display:block}
    .controls{display:flex;justify-content:space-between;margin:12px 0}
    .players-list, .games-list{display:flex;gap:8px;flex-wrap:wrap}
    .card{padding:10px;border-radius:10px;border:1px solid #eee;background:#fafafa}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eee;padding:6px;text-align:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:#1976d2;color:white;cursor:pointer}
    .btn.gray{background:#888}
    .inline{display:inline-block}
    .muted{color:#666;font-size:13px}
    .danger{background:#d32f2f}
    .dark{background:#333;color:#fff}
  </style>
</head>
<body>
<header>
  <div class="topbtns">
    <button id="logoutBtn" class="btn gray" style="display:none">ğŸšª Ø®Ø±ÙˆØ¬</button>
    <button id="activateBtn" class="btn gray" style="display:none">ğŸ”„ ØªÙ†Ø´ÙŠØ·</button>
  </div>
  <div class="userbox" id="userBox">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
</header>

<main>
  <!-- Navigation (Next/Back persistent) -->
  <div class="controls">
    <button id="backBtn" class="btn gray">â®ï¸ Ø±Ø¬ÙˆØ¹</button>
    <div>
      <button id="nextBtn" class="btn">â­ï¸ ØªÙ‚Ø¯Ù…</button>
    </div>
  </div>

  <!-- Pages -->
  <div id="pageLogin" class="page active">
    <h2>0ï¸âƒ£ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <p>Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯. ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: <strong>6666</strong></p>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select id="loginSelect"></select>
      <input id="loginPass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ" />
      <button id="loginBtn" class="btn">ğŸ”‘ Ø¯Ø®ÙˆÙ„</button>
      <button id="openRegister" class="btn gray">ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      <button id="loginAdmin" class="btn dark">ğŸ‘¤ Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ±</button>
    </div>
    <p id="loginMsg" class="muted"></p>
  </div>

  <div id="pageRegister" class="page">
    <h2>1ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <div style="max-width:400px">
      <label>Ø§Ù„Ø§Ø³Ù…</label><br>
      <input id="regName" /><br>
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><br>
      <input id="regPass" value="6666" /><br>
      <label>Ø´ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨</label><br>
      <select id="regIcon">
        <option>ğŸ‘¦</option><option>ğŸ‘§</option><option>ğŸ§‘</option><option>ğŸ§“</option>
      </select><br><br>
      <button id="sendReq" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„</button>
      <p class="muted">Ø³ÙŠØµÙ„ Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©.</p>
    </div>
  </div>

  <div id="pageHome" class="page">
    <h2>2ï¸âƒ£ ØµÙØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</h2>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div class="card">
          <div><strong>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</strong></div>
          <select id="gameSelect"></select>
          <div style="margin-top:8px">
            <button id="startGameBtn" class="btn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø¬ÙŠÙ… Ø¬Ø¯ÙŠØ¯</button>
            <button id="openGamesBtn" class="btn gray">ğŸ“‚ Ø§Ù„Ø¬ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</button>
            <button id="openStatsBtn" class="btn gray">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</button>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div><strong>Ø¥Ø­ØµØ§Ø¡Ø§Øª</strong></div>
          <div id="statsSummary" class="muted"></div>
        </div>
      </div>

      <div style="width:320px">
        <div class="card">
          <div><strong>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</strong></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <div class="muted">Online</div>
              <div id="onlineList" class="players-list"></div>
            </div>
            <div style="flex:1">
              <div class="muted">Offline</div>
              <div id="offlineList" class="players-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="pageGames" class="page">
    <h2>3ï¸âƒ£ Ø§Ù„Ø¬ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</h2>
    <div class="card">
      <div><strong>Ø¬Ø§Ø±ÙŠØ©</strong></div>
      <div id="runningGames" class="games-list"></div>
    </div>
    <div class="card" style="margin-top:10px">
      <div><strong>Ù…Ù†ØªÙ‡ÙŠØ©</strong></div>
      <div id="finishedGames" class="games-list"></div>
    </div>
  </div>

  <div id="pageGame" class="page">
    <h2>4ï¸âƒ£ ØµÙØ­Ø© Ø§Ù„Ø¬ÙŠÙ…</h2>
    <div id="gameHeader" class="card"></div>
    <div id="topPlayers" style="display:flex;gap:8px;margin-top:10px"></div>
    <div style="margin-top:10px">
      <button id="addRoundBtn" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø©</button>
      <button id="endGameBtn" class="btn danger">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙŠÙ…</button>
    </div>
    <div id="roundsArea"></div>
  </div>

  <div id="pageAdmin" class="page">
    <h2>5ï¸âƒ£ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
    <div style="display:flex;gap:12px">
      <div style="flex:1" class="card">
        <h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h4>
        <div id="requests"></div>
        <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ØªØ­Ø±ÙŠØ±)</h4>
        <div id="adminPlayers"></div>
      </div>
      <div style="flex:1" class="card">
        <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h4>
        <div id="adminGames"></div>
        <button id="addGameBtn" class="btn">Ø¥Ø¶Ø§ÙØ© Ù„Ø¹Ø¨Ø©</button>
      </div>
    </div>
  </div>

  <div id="pageStats" class="page">
    <h2>6ï¸âƒ£ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
    <div id="statsArea"></div>
  </div>

  <footer style="margin-top:18px" class="muted">Prototype - Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§</footer>
</main>

<script>
// ======= Ø¶Ø¹ firebaseConfig Ù‡Ù†Ø§ =======
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
// =====================================

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ØµÙØ­Ø§Øª ÙˆØªÙ†Ù‚Ù„
const pages = ['pageLogin','pageRegister','pageHome','pageGames','pageGame','pageAdmin','pageStats'];
let pageIndex = 0;
function showPage(i){
  pageIndex = Math.max(0, Math.min(i, pages.length-1));
  pages.forEach((p,idx)=> document.getElementById(p).classList.toggle('active', idx===pageIndex));
  // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø±
  document.getElementById('backBtn').style.display = pageIndex===0 ? 'none':'inline-block';
  document.getElementById('nextBtn').style.display = pageIndex===pages.length-1 ? 'none':'inline-block';
}
document.getElementById('nextBtn').onclick = ()=> showPage(pageIndex+1);
document.getElementById('backBtn').onclick = ()=> showPage(pageIndex-1);

// Ø¹Ù†Ø§ØµØ± Ø«Ø§Ø¨ØªØ©
const loginSelect = document.getElementById('loginSelect');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const openRegister = document.getElementById('openRegister');
const sendReq = document.getElementById('sendReq');
const loginAdmin = document.getElementById('loginAdmin');
const logoutBtn = document.getElementById('logoutBtn');
const activateBtn = document.getElementById('activateBtn');

// Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
let currentUser = null;
let localState = { players:[], games:[], requests:[], gamesObj:{} };

// Ù‚Ø§Ø¦Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨
const defaultPlayers = [
  'Ø±ÙˆÙ…Ø§Ù†ÙŠ','Ø¹Ø¨ÙŠØ±','Ø¬ÙˆØ±Ø¬','Ù†Ø±Ù…ÙŠÙ†','Ù‡Ø§Ù†ÙŠ','Ù†ÙŠØ¨Ø§Ù„','Ø´Ù†ÙˆØ¯Ù‡','Ù‡Ù†Ø§Ø¡'
];
const defaultGames = ['ÙƒÙ†ÙƒØ§Ù†','Ø§ÙˆÙ†Ùˆ','Ø¨ÙˆÙƒØ±','Ø¯ÙˆÙ…ÙŠÙ†Ùˆ','Ø§Ù„Ø·Ø§ÙˆÙ„Ø©','Ø§Ù„Ø´Ø·Ø±Ù†Ø¬','Ù…ÙˆØ§Ø¬Ù‡Ø©','Ø§Ù„Ù†Ø±Ø¯'];

// INIT: ensure DB seed
async function ensureSeed(){
  const snap = await db.ref('/meta/seeded').get();
  if(!snap.exists()){
    // add default players as users (password stored plainly - for prototype)
    const users = {};
    for(const name of defaultPlayers){
      users[name] = { password:'6666', icon: name.includes('Ø©')? 'ğŸ‘§':'ğŸ‘¦', online:false };
    }
    // add admin
    users['Romany'] = { password:'123456', icon:'ğŸ‘‘', role:'admin', online:false };
    await db.ref('/users').set(users);
    const games = {}; defaultGames.forEach(g=> games[g]={name:g});
    await db.ref('/gamesList').set(games);
    await db.ref('/meta/seeded').set(true);
  }
}
ensureSeed().catch(console.error);

// helper to refresh data every 15s
async function refreshAll(){
  // fetch users
  const uSnap = await db.ref('/users').get();
  localState.players = uSnap.exists() ? Object.keys(uSnap.val()) : [];
  // fetch games list and active games
  const gl = await db.ref('/gamesList').get();
  const gamesList = gl.exists() ? Object.keys(gl.val()) : [];
  const runningSnap = await db.ref('/activeGames').get();
  const running = runningSnap.exists() ? runningSnap.val():{};
  localState.games = running;
  // fetch requests
  const reqSnap = await db.ref('/joinRequests').get();
  localState.requests = reqSnap.exists() ? reqSnap.val() : {};
  updateUI();
}
setInterval(refreshAll,15000); // every 15s
refreshAll();

// UI updates
function updateUI(){
  // login select
  loginSelect.innerHTML = '';
  localState.players.forEach(name=> {
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
    loginSelect.appendChild(opt);
  });
  // games select
  db.ref('/gamesList').get().then(s=>{
    const sel = document.getElementById('gameSelect');
    sel.innerHTML=''; 
    if(s.exists()){
      Object.keys(s.val()).forEach(g=>{ const o=document.createElement('option'); o.value=g;o.textContent=g; sel.appendChild(o); })
    }
  });
  // online/offline lists
  db.ref('/users').get().then(s=>{
    const users = s.exists()? s.val():{};
    const onlineDiv = document.getElementById('onlineList'); const offlineDiv = document.getElementById('offlineList');
    onlineDiv.innerHTML=''; offlineDiv.innerHTML='';
    Object.keys(users).forEach(name=>{
      const el = document.createElement('div'); el.className='card inline'; el.textContent = (users[name].icon||'') + ' ' + name;
      if(users[name].online){
        onlineDiv.appendChild(el);
      } else offlineDiv.appendChild(el);
    });
  });
  // running games
  const runningDiv = document.getElementById('runningGames'); runningDiv.innerHTML='';
  const finishedDiv = document.getElementById('finishedGames'); finishedDiv.innerHTML='';
  const games = localState.games || {};
  Object.keys(games).forEach(id=>{
    const g = games[id];
    const el = document.createElement('div'); el.className='card inline'; el.style.minWidth='200px';
    el.innerHTML = `<strong>${g.gameName}</strong><div class="muted">${g.status||'running'}</div>`;
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='â–¶ï¸ Ø§ÙØªØ­'; btn.onclick=()=> openGame(id);
    el.appendChild(btn);
    if(g.ended) finishedDiv.appendChild(el); else runningDiv.appendChild(el);
  });
  // admin area
  const reqDiv = document.getElementById('requests'); reqDiv.innerHTML='';
  Object.keys(localState.requests || {}).forEach(k=>{
    const r = localState.requests[k]; const d=document.createElement('div'); d.className='card';
    d.innerHTML = `<div>${r.name} - ${r.icon}</div>`;
    const a=document.createElement('button'); a.className='btn'; a.textContent='âœ”ï¸ Ù‚Ø¨ÙˆÙ„'; a.onclick=()=> handleRequest(k,true);
    const x=document.createElement('button'); x.className='btn gray'; x.textContent='âœ–ï¸ Ø±ÙØ¶'; x.onclick=()=> handleRequest(k,false);
    d.appendChild(a); d.appendChild(x); reqDiv.appendChild(d);
  });
}

// Login flow (custom auth using /users node)
loginBtn.onclick = async ()=>{
  const name = loginSelect.value; const pass = document.getElementById('loginPass').value;
  if(!name){ loginMsg.textContent='Ø§Ø®ØªØ§Ø± Ø§Ø³Ù…'; return; }
  const snap = await db.ref('/users/'+name).get();
  if(!snap.exists()){ loginMsg.textContent='Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„'; return; }
  const data = snap.val();
  if(data.password !== pass){ loginMsg.textContent='ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©'; return; }
  // set online
  await db.ref('/users/'+name+'/online').set(true);
  currentUser = { name, ...data };
  document.getElementById('userBox').textContent = `${currentUser.icon||''} ${name}`;
  document.getElementById('logoutBtn').style.display='inline-block';
  document.getElementById('activateBtn').style.display='inline-block';
  loginMsg.textContent='';
  showPage(2); refreshAll();
};

openRegister.onclick = ()=> showPage(1);
document.getElementById('sendReq').onclick = async ()=>{
  const name = document.getElementById('regName').value.trim(); const pass = document.getElementById('regPass').value;
  const icon = document.getElementById('regIcon').value;
  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…'); return; }
  // push request
  await db.ref('/joinRequests').push({ name, password:pass, icon, created:Date.now() });
  alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ±');
  showPage(0);
};

// admin login - simple prompt for Romany
loginAdmin.onclick = async ()=>{
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (Romany)'); const pass = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±');
  if(name==='Romany' && pass==='123456'){
    // mark admin online
    await db.ref('/users/Romany/online').set(true);
    currentUser = { name:'Romany', role:'admin', icon:'ğŸ‘‘' };
    document.getElementById('userBox').textContent = 'ğŸ‘‘ Romany';
    document.getElementById('logoutBtn').style.display='inline-block';
    showPage(5);
    refreshAll();
  } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
};

logoutBtn.onclick = async ()=>{
  if(currentUser){
    await db.ref('/users/'+currentUser.name+'/online').set(false);
    currentUser = null;
    document.getElementById('userBox').textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('activateBtn').style.display='none';
    showPage(0);
    refreshAll();
  }
};

activateBtn.onclick = ()=> refreshAll();

// handle requests (admin)
async function handleRequest(key, accept){
  const r = (await db.ref('/joinRequests/'+key).get()).val();
  if(!r) return;
  if(accept){
    // create user
    await db.ref('/users/'+r.name).set({ password:r.password, icon:r.icon, online:false });
    alert('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ '+r.name);
  }
  await db.ref('/joinRequests/'+key).remove();
  refreshAll();
}

// start game flow
document.getElementById('startGameBtn').onclick = async ()=>{
  if(!currentUser){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  // choose game and select players from online list (multi-select simple)
  const gameName = document.getElementById('gameSelect').value;
  // load online users
  const usersSnap = await db.ref('/users').get(); const users = usersSnap.val()||{};
  const online = Object.keys(users).filter(n=> users[n].online && n!==currentUser.name);
  // dialog simple: ask to invite comma-separated names
  const invite = prompt('Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ù† Online Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©\nÙ…ØªØ§Ø­: '+online.join(','), online.join(','));
  if(invite===null) return;
  const invited = invite.split(',').map(s=>s.trim()).filter(Boolean);
  // ensure all invited are online
  const invalid = invited.filter(n=> !users[n] || !users[n].online);
  if(invalid.length){ alert('Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ØºÙŠØ± Ù…ØªØµÙ„ÙŠÙ†: '+invalid.join(',')); return; }
  // create activeGame
  const newRef = db.ref('/activeGames').push();
  const gameObj = {
    gameName, createdBy: currentUser.name, players: {}, status:'waiting', createdAt:Date.now(), recorder:null, rounds:{}
  };
  // set invited players state = pending
  invited.forEach(n=> gameObj.players[n] = { status:'pending', score:0 });
  // include starter as accepted
  gameObj.players[currentUser.name] = { status:'accepted', score:0 };
  await newRef.set(gameObj);
  // send invites by writing invitations node per user
  Object.keys(gameObj.players).forEach(p=>{
    if(p!==currentUser.name) db.ref('/invitations/'+p+'/'+newRef.key).set({ from: currentUser.name, gameName, status:'pending' });
  });
  refreshAll();
  alert('Ø¯Ø¹ÙˆØ§Øª Ø£Ø±Ø³Ù„Øª'); showPage(3);
};

// accept invitation dialog (client polls invitations node)
setInterval(async ()=>{
  if(!currentUser) return;
  const invSnap = await db.ref('/invitations/'+currentUser.name).get();
  if(!invSnap.exists()) return;
  const inv = invSnap.val();
  Object.keys(inv).forEach(async key=>{
    const info = inv[key];
    const ans = confirm(`Ø¯Ø¹ÙˆØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø© ${info.gameName} Ù…Ù† ${info.from}\nÙ‡Ù„ ØªÙ‚Ø¨Ù„ØŸ`);
    if(ans){
      // update game player status
      await db.ref('/activeGames/'+key+'/players/'+currentUser.name+'/status').set('accepted');
      await db.ref('/invitations/'+currentUser.name+'/'+key).remove();
      refreshAll();
    } else {
      // set declined and remove invitation
      await db.ref('/activeGames/'+key+'/players/'+currentUser.name+'/status').set('declined');
      await db.ref('/invitations/'+currentUser.name+'/'+key).remove();
      refreshAll();
    }
  });
},5000);

// open game page
async function openGame(id){
  const gSnap = await db.ref('/activeGames/'+id).get(); if(!gSnap.exists()){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙŠÙ…'); return; }
  const g = gSnap.val(); g._id = id;
  // check if user allowed to view
  if(!currentUser){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  // populate header and rounds
  document.getElementById('gameHeader').innerHTML = `<div><strong>${g.gameName}</strong> - Ù…Ø¯ÙŠØ±: ${g.createdBy}</div>`;
  // build top 3 and table
  const playersArr = Object.keys(g.players).map(n=> ({name:n, score:g.players[n].score||0}) ).sort((a,b)=> b.score-a.score);
  const topDiv = document.getElementById('topPlayers'); topDiv.innerHTML='';
  playersArr.slice(0,3).forEach(p=> { const c=document.createElement('div'); c.className='card'; c.style.minWidth='120px'; c.innerHTML=`<div>${p.name}</div><div class="muted">${p.score}</div>`; topDiv.appendChild(c); });
  // rounds area
  const roundsDiv = document.getElementById('roundsArea'); roundsDiv.innerHTML='';
  const rounds = g.rounds || {};
  // show total row
  const table = document.createElement('table'); const thead = document.createElement('thead');
  const headerRow = document.createElement('tr'); headerRow.innerHTML = '<th>Ø§Ù„Ø¬ÙˆÙ„Ø©</th>' + playersArr.map(p=>`<th>${p.name}</th>`).join(''); thead.appendChild(headerRow); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  // rounds in reverse (last on top)
  const roundKeys = Object.keys(rounds||{}).reverse();
  roundKeys.forEach((rk,idx)=>{
    const r = rounds[rk];
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.name||('Ø¬ÙˆÙ„Ø© '+rk)}</td>` + playersArr.map(p=>`<td>${r.scores && r.scores[p.name] != null ? r.scores[p.name] : ''}</td>`).join('');
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  roundsDiv.appendChild(table);
  // store current game in local var for actions
  window._openGame = g; window._openGameId = id;
  showPage(4);
}

// add round (only accepted players or recorder can)
document.getElementById('addRoundBtn').onclick = async ()=>{
  const g = window._openGame; const id = window._openGameId; if(!g) return alert('Ø§ÙØªØ­ Ø¬ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹');
  // check permissions: if currentUser is accepted or is createdBy
  if(!g.players[currentUser.name] || g.players[currentUser.name].status!=='accepted'){ return alert('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆÙ„Ø§Øª'); }
  const roundName = prompt('Ø§Ø³Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)');
  // prompt scores for each player sequentially
  const scores = {};
  for(const p of Object.keys(g.players)){
    const val = prompt(`Ø§Ù„Ø³ÙƒÙˆØ± Ù„Ù„Ø§Ø¹Ø¨ ${p} (Ø§ØªØ±Ùƒ ÙØ§Ø±Øº Ø¥Ù† Ù„Ù… ÙŠÙƒÙ†)`,'0');
    if(val!==null && val!=='') scores[p] = parseInt(val||0);
  }
  const newRef = db.ref('/activeGames/'+id+'/rounds').push();
  await newRef.set({ name: roundName || ('Ø¬ÙˆÙ„Ø© '+Date.now()), scores });
  // update total scores
  const gSnap = await db.ref('/activeGames/'+id).get(); const g2 = gSnap.val();
  for(const p of Object.keys(g2.players)){
    let total = 0;
    const rs = g2.rounds || {};
    Object.values(rs).forEach(r=>{ if(r.scores && r.scores[p]) total += Number(r.scores[p]) });
    await db.ref('/activeGames/'+id+'/players/'+p+'/score').set(total);
  }
  refreshAll(); openGame(id);
};

// end game
document.getElementById('endGameBtn').onclick = async ()=>{
  const g = window._openGame; const id = window._openGameId; if(!g) return;
  // only allow creator or accepted partner to end (simplified: creator only)
  if(currentUser.name !== g.createdBy && currentUser.role!=='admin'){ return alert('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙŠÙ…'); }
  await db.ref('/activeGames/'+id+'/ended').set(true);
  await db.ref('/activeGames/'+id+'/endedAt').set(Date.now());
  // mark ended flag
  await db.ref('/activeGames/'+id+'/ended').set(true);
  refreshAll(); showPage(3);
};

// admin actions: add game
document.getElementById('addGameBtn').onclick = async ()=>{
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯');
  if(!name) return;
  await db.ref('/gamesList/'+name).set({name});
  refreshAll();
};

// stats simple
document.getElementById('openStatsBtn').onclick = ()=> showPage(6);

// page navigation guards: prevent entering a game already started (simple enforcement)
async function guardNext(){
  if(pageIndex===2){ // from home to games? no guard
    return true;
  }
  return true;
}
document.getElementById('nextBtn').onclick = async ()=>{ const ok = await guardNext(); if(ok) showPage(pageIndex+1); };

// initial UI refresh
refreshAll();

// warn on unload: set offline
window.addEventListener('beforeunload', async ()=>{
  if(currentUser) await db.ref('/users/'+currentUser.name+'/online').set(false);
});
</script>
</body>
</html>
